<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromptWizard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <div class="container mx-auto p-4 flex-grow flex flex-col">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">PromptWizard</h1>
        
        <div class="flex flex-grow overflow-hidden">
            <!-- Categories Sidebar -->
            <div class="w-1/4 bg-white p-4 rounded-lg shadow-md mr-4 overflow-y-auto custom-scrollbar">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Categories</h2>
                <ul id="categoryList" class="space-y-2">
                    <!-- Categories will be dynamically inserted here -->
                </ul>
                <button id="newCategoryBtn" class="mt-4 w-full px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-300">New Category</button>
            </div>

            <!-- Prompts and Content -->
            <div class="flex-grow flex flex-col">
                <div class="mb-4 flex">
                    <input type="text" id="searchInput" placeholder="Search prompts..." class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="newPromptBtn" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300">New Prompt</button>
                </div>
                
                <div id="promptContent" class="bg-white p-4 rounded-lg shadow-md flex-grow overflow-y-auto custom-scrollbar">
                    <p class="text-gray-500 text-center mt-8">Select a prompt to view its content.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- New Category Modal -->
    <div id="newCategoryModal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-md w-1/3">
            <h2 class="text-xl font-bold mb-4">New Category</h2>
            <input type="text" id="newCategoryName" placeholder="Category Name" class="w-full p-2 border border-gray-300 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex justify-end">
                <button id="cancelNewCategory" class="mr-2 px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition duration-300">Cancel</button>
                <button id="saveNewCategory" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-300">Save</button>
            </div>
        </div>
    </div>

    <!-- New/Edit Prompt Modal -->
    <div id="promptModal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-md w-1/2">
            <h2 id="promptModalTitle" class="text-xl font-bold mb-4">New Prompt</h2>
            <input type="text" id="promptName" placeholder="Prompt Name" class="w-full p-2 border border-gray-300 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <textarea id="promptContents" placeholder="Prompt Contents" class="w-full p-2 border border-gray-300 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="6"></textarea>
            <div class="flex items-center mb-4">
                <select id="promptCategory" class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <!-- Categories will be dynamically inserted here -->
                </select>
                <button id="newCategoryInPromptBtn" class="ml-2 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-300">New Category</button>
            </div>
            <div class="flex justify-end">
                <button id="cancelPrompt" class="mr-2 px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition duration-300">Cancel</button>
                <button id="savePrompt" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300">Save</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-md w-1/2">
            <h2 class="text-xl font-bold mb-4 text-red-600">Error</h2>
            <p id="errorMessage" class="mb-4"></p>
            <div class="flex justify-end">
                <button id="closeError" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-300">Close</button>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading hidden">
        <div class="loading-spinner"></div>
    </div>

<script>
    const API_URL = '/api';
    let currentCategory = null;
    let currentPrompt = null;

    function showLoading() {
        document.getElementById('loadingIndicator').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loadingIndicator').classList.add('hidden');
    }

    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorModal').classList.remove('hidden');
    }

    function showConfirmation(message, onConfirm, onCancel) {
        const existingModal = document.getElementById('confirmationModal');
        if (existingModal) {
            document.body.removeChild(existingModal);
        }

        const confirmationModal = document.createElement('div');
        confirmationModal.id = 'confirmationModal';
        confirmationModal.className = 'fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 z-50';
        confirmationModal.innerHTML = `
            <div class="bg-white p-6 rounded-md w-1/3">
                <h2 class="text-xl font-bold mb-4">Confirm Action</h2>
                <p class="mb-4">${message}</p>
                <div class="flex justify-end">
                    <button id="cancelConfirmation" class="mr-2 px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition duration-300">Cancel</button>
                    <button id="confirmAction" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-300">Confirm</button>
                </div>
            </div>
        `;
        document.body.appendChild(confirmationModal);

        const cancelButton = document.getElementById('cancelConfirmation');
        const confirmButton = document.getElementById('confirmAction');

        cancelButton.addEventListener('click', () => {
            document.body.removeChild(confirmationModal);
            if (onCancel) onCancel();
        });

        confirmButton.addEventListener('click', () => {
            document.body.removeChild(confirmationModal);
            onConfirm();
        });
    }

    async function fetchCategories() {
        try {
            showLoading();
            const response = await axios.get(`${API_URL}/categories`);
            hideLoading();
            return response.data;
        } catch (error) {
            hideLoading();
            console.error('Error fetching categories:', error);
            showError(`Error fetching categories: ${error.response?.data?.detail || error.message}`);
            return [];
        }
    }

    async function fetchPrompts(categoryId = null) {
        try {
            showLoading();
            const url = categoryId ? `${API_URL}/prompts?category_id=${categoryId}` : `${API_URL}/prompts`;
            const response = await axios.get(url);
            hideLoading();
            return response.data;
        } catch (error) {
            hideLoading();
            console.error('Error fetching prompts:', error);
            showError(`Error fetching prompts: ${error.response?.data?.detail || error.message}`);
            return [];
        }
    }

    function createCategoryListItem(category, prompts) {
        const promptsList = prompts.map(prompt => `
            <li class="prompt-item ml-6 cursor-pointer p-1 hover:bg-gray-200 rounded" data-id="${prompt.id}">
                ${prompt.name}
            </li>
        `).join('');

        return `
            <li class="category-item mb-2" data-id="${category.id}">
                <div class="flex items-center justify-between cursor-pointer p-2 hover:bg-gray-200 rounded">
                    <div class="flex items-center">
                        <i class="fas fa-folder mr-2 text-yellow-500"></i>
                        <span>${category.name}</span>
                    </div>
                    <div>
                        <i class="fas fa-trash-alt text-red-500 hover:text-red-700 mr-2 delete-category"></i>
                        <i class="fas fa-chevron-down text-gray-500"></i>
                    </div>
                </div>
                <ul class="prompt-list hidden">
                    ${promptsList}
                </ul>
            </li>
        `;
    }

    function displayPromptContent(prompt) {
        const promptContent = document.getElementById('promptContent');
        promptContent.innerHTML = `
            <h2 class="text-xl font-bold mb-2">${prompt.name}</h2>
            <pre class="whitespace-pre-wrap text-sm mb-4">${prompt.contents}</pre>
            <div class="flex justify-end">
                <button id="movePromptBtn" class="mr-2 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300">Move</button>
                <button id="editPromptBtn" class="mr-2 px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition duration-300">Edit</button>
                <button id="deletePromptBtn" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-300">Delete</button>
            </div>
        `;
        document.getElementById('movePromptBtn').addEventListener('click', () => showPromptModal(prompt, true));
        document.getElementById('editPromptBtn').addEventListener('click', () => showPromptModal(prompt));
        document.getElementById('deletePromptBtn').addEventListener('click', () => deletePrompt(prompt.id));
    }

    async function displayCategories() {
        const categoryList = document.getElementById('categoryList');
        const categories = await fetchCategories();
        
        let categoryItems = '';
        for (const category of categories) {
            const prompts = await fetchPrompts(category.id);
            categoryItems += createCategoryListItem(category, prompts);
        }
        categoryList.innerHTML = categoryItems;
        
        categoryList.addEventListener('click', async (event) => {
            const categoryItem = event.target.closest('.category-item');
            if (categoryItem) {
                const icon = categoryItem.querySelector('.fa-chevron-down, .fa-chevron-up');
                const promptList = categoryItem.querySelector('.prompt-list');
                
                if (icon.classList.contains('fa-chevron-down')) {
                    icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                    promptList.classList.remove('hidden');
                } else {
                    icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                    promptList.classList.add('hidden');
                }
            }

            if (event.target.classList.contains('delete-category')) {
                const categoryId = categoryItem.dataset.id;
                await deleteCategory(categoryId);
                return;
            }

            const promptItem = event.target.closest('.prompt-item');
            if (promptItem) {
                const id = parseInt(promptItem.dataset.id);
                const categoryId = parseInt(categoryItem.dataset.id);
                const prompts = await fetchPrompts(categoryId);
                currentPrompt = prompts.find(p => p.id === id);
                displayPromptContent(currentPrompt);
                document.querySelectorAll('.prompt-item').forEach(item => item.classList.remove('bg-blue-100'));
                promptItem.classList.add('bg-blue-100');
            }
        });

        // Populate category select in the prompt modal
        updateCategorySelect();
    }

    async function updateCategorySelect() {
        const categories = await fetchCategories();
        const promptCategory = document.getElementById('promptCategory');
        promptCategory.innerHTML = `<option value="">Select a category</option>` + 
            categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
    }

    function filterPrompts() {
        const searchInput = document.getElementById('searchInput');
        const filter = searchInput.value.toLowerCase();
        const promptItems = document.querySelectorAll('.prompt-item');
        
        promptItems.forEach(item => {
            const text = item.textContent.toLowerCase();
            const categoryItem = item.closest('.category-item');
            const icon = categoryItem.querySelector('.fa-chevron-down, .fa-chevron-up');
            const promptList = categoryItem.querySelector('.prompt-list');
            
            if (text.includes(filter)) {
                item.style.display = '';
                categoryItem.style.display = '';
                icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                promptList.classList.remove('hidden');
            } else {
                item.style.display = 'none';
                if (categoryItem.querySelectorAll('.prompt-item[style="display: none;"]').length === categoryItem.querySelectorAll('.prompt-item').length) {
                    categoryItem.style.display = 'none';
                }
            }
        });
    }

    function showNewCategoryModal() {
        document.getElementById('newCategoryModal').classList.remove('hidden');
    }

    function hideNewCategoryModal() {
        document.getElementById('newCategoryModal').classList.add('hidden');
        document.getElementById('newCategoryName').value = '';
    }

    async function saveNewCategory() {
        const name = document.getElementById('newCategoryName').value;

        if (name) {
            try {
                showLoading();
                const response = await axios.post(`${API_URL}/categories`, { name });
                hideLoading();
                hideNewCategoryModal();
                await displayCategories();
                return response.data;
            } catch (error) {
                hideLoading();
                console.error('Error saving new category:', error);
                showError(`Error saving new category: ${error.response?.data?.detail || error.message}`);
            }
        } else {
            showError('Please enter a category name.');
        }
    }

    async function deleteCategory(categoryId) {
        showConfirmation('Are you sure you want to delete this category? All prompts in this category will also be deleted.', async () => {
            try {
                showLoading();
                await axios.delete(`${API_URL}/categories/${categoryId}`);
                hideLoading();
                await displayCategories();
                document.getElementById('promptContent').innerHTML = '<p class="text-gray-500 text-center mt-8">Select a prompt to view its content.</p>';
            } catch (error) {
                hideLoading();
                console.error('Error deleting category:', error);
                if (error.response && error.response.status === 404) {
                    showError('Category not found. It may have been already deleted.');
                    await displayCategories(); // Refresh the category list
                } else {
                    showError(`Error deleting category: ${error.response?.data?.detail || error.message}`);
                }
            }
        });
    }

    function showPromptModal(prompt = null, isMoving = false) {
        const modal = document.getElementById('promptModal');
        const title = document.getElementById('promptModalTitle');
        const nameInput = document.getElementById('promptName');
        const contentsInput = document.getElementById('promptContents');
        const categorySelect = document.getElementById('promptCategory');

        if (prompt) {
            title.textContent = isMoving ? 'Move Prompt' : 'Edit Prompt';
            nameInput.value = prompt.name;
            contentsInput.value = prompt.contents;
            categorySelect.value = prompt.category_id;
            currentPrompt = prompt;
        } else {
            title.textContent = 'New Prompt';
            nameInput.value = '';
            contentsInput.value = '';
            categorySelect.value = currentCategory || '';
            currentPrompt = null;
        }

        if (isMoving) {
            nameInput.disabled = true;
            contentsInput.disabled = true;
        } else {
            nameInput.disabled = false;
            contentsInput.disabled = false;
        }

        modal.classList.remove('hidden');
    }

    function hidePromptModal() {
        document.getElementById('promptModal').classList.add('hidden');
    }

    async function savePrompt() {
        const name = document.getElementById('promptName').value;
        const contents = document.getElementById('promptContents').value;
        const category_id = document.getElementById('promptCategory').value;

        if (name && contents && category_id) {
            try {
                showLoading();
                let updatedPrompt;
                if (currentPrompt) {
                    const response = await axios.put(`${API_URL}/prompts/${currentPrompt.id}`, { name, contents, category_id });
                    updatedPrompt = response.data;
                } else {
                    const response = await axios.post(`${API_URL}/prompts`, { name, contents, category_id });
                    updatedPrompt = response.data;
                }
                hideLoading();
                hidePromptModal();

                // Update the UI for both the old and new categories
                if (currentPrompt && currentPrompt.category_id !== updatedPrompt.category_id) {
                    // Remove the prompt from the old category
                    const oldCategoryItem = document.querySelector(`.category-item[data-id="${currentPrompt.category_id}"]`);
                    if (oldCategoryItem) {
                        const oldPromptItem = oldCategoryItem.querySelector(`.prompt-item[data-id="${currentPrompt.id}"]`);
                        if (oldPromptItem) {
                            oldPromptItem.remove();
                        }
                    }
                }

                // Add or update the prompt in the new category
                const newCategoryItem = document.querySelector(`.category-item[data-id="${updatedPrompt.category_id}"]`);
                if (newCategoryItem) {
                    const promptList = newCategoryItem.querySelector('.prompt-list');
                    const existingPromptItem = promptList.querySelector(`.prompt-item[data-id="${updatedPrompt.id}"]`);
                    if (existingPromptItem) {
                        existingPromptItem.textContent = updatedPrompt.name;
                    } else {
                        const newPromptItem = document.createElement('li');
                        newPromptItem.className = 'prompt-item ml-6 cursor-pointer p-1 hover:bg-gray-200 rounded';
                        newPromptItem.dataset.id = updatedPrompt.id;
                        newPromptItem.textContent = updatedPrompt.name;
                        promptList.appendChild(newPromptItem);
                    }

                    // Ensure the category is expanded
                    const icon = newCategoryItem.querySelector('.fa-chevron-down, .fa-chevron-up');
                    if (icon.classList.contains('fa-chevron-down')) {
                        icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                        promptList.classList.remove('hidden');
                    }
                }

                // Update the current prompt
                currentPrompt = updatedPrompt;

                // Refresh the prompt content display
                displayPromptContent(updatedPrompt);

            } catch (error) {
                hideLoading();
                console.error('Error saving prompt:', error);
                showError(`Error saving prompt: ${error.response?.data?.detail || error.message}`);
            }
        } else {
            showError('Please fill in all fields.');
        }
    }

    async function deletePrompt(id) {
        showConfirmation('Are you sure you want to delete this prompt?', async () => {
            try {
                showLoading();
                await axios.delete(`${API_URL}/prompts/${id}`);
                hideLoading();
                await displayCategories();
                document.getElementById('promptContent').innerHTML = '<p class="text-gray-500 text-center mt-8">Select a prompt to view its content.</p>';
            } catch (error) {
                hideLoading();
                console.error('Error deleting prompt:', error);
                if (error.response && error.response.status === 404) {
                    showError('Prompt not found. It may have been already deleted.');
                    await displayCategories(); // Refresh the category list
                } else {
                    showError(`Error deleting prompt: ${error.response?.data?.detail || error.message}`);
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        displayCategories();
        document.getElementById('searchInput').addEventListener('input', filterPrompts);
        document.getElementById('newCategoryBtn').addEventListener('click', showNewCategoryModal);
        document.getElementById('cancelNewCategory').addEventListener('click', hideNewCategoryModal);
        document.getElementById('saveNewCategory').addEventListener('click', saveNewCategory);
        document.getElementById('newPromptBtn').addEventListener('click', () => showPromptModal());
        document.getElementById('cancelPrompt').addEventListener('click', hidePromptModal);
        document.getElementById('savePrompt').addEventListener('click', savePrompt);
        document.getElementById('closeError').addEventListener('click', () => document.getElementById('errorModal').classList.add('hidden'));
        document.getElementById('newCategoryInPromptBtn').addEventListener('click', async () => {
            const newCategory = await saveNewCategory();
            if (newCategory) {
                await updateCategorySelect();
                document.getElementById('promptCategory').value = newCategory.id;
            }
        });
    });
    </script>

    <!-- Include the console tests script -->
    <script src="/tests/console_tests.js"></script>
    <script>
        // Make runTests function globally available
        window.runTests = runTests;
    </script>
</body>
</html>
